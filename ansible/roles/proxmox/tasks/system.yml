---
# =============================================================================
# SYSTEM CONFIGURATION TASKS
# =============================================================================

- name: Update package cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  when: proxmox_update_cache

- name: Upgrade system packages
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  when: proxmox_upgrade_packages
  register: apt_upgrade_result

- name: Check if reboot is required
  stat:
    path: /var/run/reboot-required
  register: reboot_required_file

- name: Set reboot fact
  set_fact:
    system_reboot_required: "{{ reboot_required_file.stat.exists or (apt_upgrade_result.changed and 'kernel' in apt_upgrade_result.stdout) }}"

- name: Notify about reboot requirement
  debug:
    msg: "System reboot is required due to package updates"
  when: system_reboot_required and proxmox_check_reboot_required

- name: Configure timezone
  timezone:
    name: "{{ proxmox_timezone }}"
  when: proxmox_timezone is defined
  notify: restart rsyslog

- name: Ensure SSH service is enabled and running
  systemd:
    name: ssh
    state: started
    enabled: yes
  when: proxmox_ensure_ssh_running

- name: Configure NTP/Timesyncd
  systemd:
    name: systemd-timesyncd
    state: started
    enabled: yes
  when: proxmox_configure_ntp