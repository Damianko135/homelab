---
# =============================================================================
# WEB UI MODIFICATION TASKS
# =============================================================================

- name: Check if proxmoxlib.js exists
  stat:
    path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
  register: proxmoxlib_file

- name: Check if proxmoxlib.js backup exists
  stat:
    path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js.bak
  register: proxmoxlib_backup
  when: proxmoxlib_file.stat.exists

- name: Backup proxmoxlib.js before modification
  copy:
    src: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
    dest: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js.bak
    remote_src: true
    owner: root
    group: root
    mode: "0644"
  when: 
    - proxmoxlib_file.stat.exists
    - not proxmoxlib_backup.stat.exists
    - proxmox_disable_subscription_nag

- name: Disable subscription notification popup (Primary method)
  replace:
    path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
    regexp: 'Ext\.Msg\.show\(\s*{\s*title:\s*gettext\(.*?No valid subscription.*?\)[\s\S]*?}\);'
    replace: "// Subscription notification disabled by Ansible"
    backup: yes
  when: 
    - proxmoxlib_file.stat.exists
    - proxmox_disable_subscription_nag
  notify: restart pveproxy
  ignore_errors: true

- name: Disable subscription check (Alternative method 1)
  replace:
    path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
    regexp: "if \\(res === null \\|\\| res === undefined \\|\\| !res \\|\\| res\\.data\\.status\\.toLowerCase\\(\\) !== 'active'\\)"
    replace: "if (false)"
    backup: yes
  when: 
    - proxmoxlib_file.stat.exists
    - proxmox_disable_subscription_nag
  notify: restart pveproxy
  ignore_errors: true

- name: Disable subscription check (Alternative method 2)
  replace:
    path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
    regexp: "checked_command: function\\(orig_cmd\\) \\{[\\s\\S]*?\\}"
    replace: "checked_command: function(orig_cmd) { return orig_cmd(); }"
    backup: yes
  when: 
    - proxmoxlib_file.stat.exists
    - proxmox_disable_subscription_nag
  notify: restart pveproxy
  ignore_errors: true

- name: Verify Web UI service is running
  systemd:
    name: pveproxy
    state: started
    enabled: yes
  when: proxmox_ensure_web_ui_running